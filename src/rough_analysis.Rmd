---
title: "ROUGH_ANALYSIS"
author: "SP"
date: "26/11/2020"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(testthat)
library(docopt)
library(arrow)
library(vegan)
library(knitr)
library(broom)

```

```{r Load/Format Data}
df <- read_feather('../data/processed/aliens_pro.feather')
# df <- read_csv('../data/processed/aliens.csv')

df <- df %>% 
  select(Shape, duration_sec) %>% 
  filter(Shape != c('Flash','Light')) %>% 
  mutate('duration_log_sec' = log10(duration_sec),
         Shape = factor(Shape))

```

```{r vis}
ggplot(df) +
  aes(x = duration_sec,
      y = Shape)+
  geom_violin()

ggplot(df) +
  aes(x = duration_sec,
      y = Shape)+
  geom_violin() +
  scale_x_log10()
```

```{r Kruskal-Wallis}
library(FSA)

# df$Shape <- factor(df$Shape)

kusk <- kruskal.test(duration_sec ~ Shape, data = df)


dunn <- dunnTest(duration_sec ~ Shape, data = df, method='bonferroni', table=TRUE)
dunn_table <- dunn$res
dunn_table

alpha <- 0.05

```

```{r One way ANOVA with permuation}
library(coin)
library(rcompanion)

df$Shape <- factor(df$Shape)

one_anova <- aov(duration_log_sec ~ Shape, data = df)
tidy(one_anova)

pairwise_perm <- pairwisePermutationTest(duration_log_sec ~ Shape, data = df)
pairwise_perm

#Visualization
alpha <- 0.05
pairwise_matrix <- pairwisePermutationMatrix(duration_log_sec ~ Shape, data = df)
pairwise_matrix_sig <- pairwise_matrix$Adjusted < alpha

library(ggplot2)
library(reshape2)

pairwise_melted = melt(pairwise_matrix_sig)


ggplot(pairwise_melted) +
  aes(x = Var1,
      y = Var2,
      fill = value) +
  geom_tile() +
  scale_fill_manual(labels = c('Cannot reject null (p>0.05)','Null rejected(p<0.05)', ''),values=c('white','black'), na.value = 'white') +
  theme(axis.text.x = element_text(angle = 90),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        legend.title=element_blank())
      

# pairwise_matrix_sig <- tibble(ifelse(pairwise_matrix > alpha, FALSE, TRUE))
# pairwise_matrix_sig
```

```{r permANOVA}
# # ATTEMPTING TO FIGURE OUT HOW ADONIS WORKS
# test_data <- data.frame(c(1,2,3,1,1,5))
# test_class <- data.frame(shape = c('s','s','s','r','r','r'))
# data_dist <- dist(test_data, method='euclidean')
# 
# adonis(data_dist ~ shape, data=test_class)
# 
# library(here)
# 
# fp_pro = 'data/processed/aliens_pro.feather'
# fp_results = 'data'
# 
# processed_data <- read_feather(here(fp_pro))
# 
# # Remove unwanted shapes and group data
# shape_duration <- processed_data %>% 
#   select(Shape, duration_sec) %>% 
#   filter(Shape != c('Flash','Light')) %>% 
#   mutate(Shape = factor(Shape))
# 
# # Kruskal-Wallis test
# kusk <- kruskal.test(duration_sec ~ Shape, data = df)
# write_rds(tidy(kusk), here(fp_results,'KW.rds'))
# 
# dunn <- dunnTest(duration_sec ~ Shape, data = df, method='bonferroni')
# dunn_table <- dunn$res
# filter(dunn_table,

  # Kruskal-Wallis test
  # kusk <- kruskal.test(duration_sec ~ Shape, data = df)
  # write_rds(tidy(kusk), here(opt$fp_results,'KW.rds'))
  
  # Dunn Test
  # Dunn_table <- DunnTest(df$duration_sec, df$Shape, method='bonferroni')
  # Dunn_table <- as_tibble(Dunn_table[[1]], rownames = 'Comparison') %>% 
  #   select(Comparison, pval) %>% 
  #   filter(pval>alpha) %>% 
  #   write_rds(here(opt$fp_results,'Dunn.rds'))
  
  # Create matrix of pairwise adjusted p values from Dunn test for plotting

library(DescTools)
library(reshape2)
library(ggplot2)

alpha=0.05

Dunn_matrix <- DunnTest(df$duration_sec, df$Shape, method='bonferroni', out.list=FALSE)[[1]]
n_shapes = dim(Dunn_matrix)[1] + 1
Dunn_matrix=rbind(rep(NA,n_shapes-1),Dunn_matrix)
Dunn_matrix=cbind(Dunn_matrix,rep(NA,n_shapes))
rownames(Dunn_matrix)[1] = colnames(Dunn_matrix)[1]
colnames(Dunn_matrix)[n_shapes]=rownames(Dunn_matrix)[n_shapes]
# Dunn_matrix <- t(Dunn_matrix)
# Dunn_matrix <- Dunn_matrix[[1]]*lower.tri(Dunn_matrix[[1]], diag = TRUE)

pairwise_matrix_sig <- Dunn_matrix < alpha
pairwise_melted <- melt(pairwise_matrix_sig)
```

```{r}


```

ggplot(pairwise\_melted) +

aes(x = Var1,

y = Var2,

fill = value) +

geom\_tile() +

scale\_fill\_manual(labels= c('Fail to reject null hypothesis (p\>0.05)', 'Reject null hypothesis (p\<0.05)', ''),values=c('grey','red'), na.value = 'white') +

theme(axis.text.x = element\_text(angle = 90),

axis.title.x=element\_blank(),

axis.title.y=element\_blank(),

legend.title=element\_blank())+

ggtitle("Results of pairwise comparison of duration \\n distributions using Dunn's Test")

```{r}
library(DescTools)

Dunn_table <- DunnTest(df$duration_sec, df$Shape, method='bonferroni')
Dunn_matrix <- DunnTest(df$duration_sec, df$Shape, method='bonferroni', out.list=FALSE)
# dunn_table <- 
# dunn_table
# 
# alpha <- 0.05

# pairwise_matrix_sig <- dunn$res$P.adj < alpha
# 
# library(ggplot2)
# library(reshape2)
# 
# pairwise_melted = melt(pairwise_matrix_sig)
# 
# 
# ggplot(pairwise_melted) +
#   aes(x = Var1,
#       y = Var2,
#       fill = value) +
#   geom_tile() +
#   scale_fill_manual(labels = c('Cannot reject null (p>0.05)','Null rejected(p<0.05)', ''),values=c('white','black'), na.value = 'white') +
#   theme(axis.text.x = element_text(angle = 90),
#         axis.title.x=element_blank(),
#         axis.title.y=element_blank(),
#         legend.title=element_blank())
```

```{r permANOVA EXs}
# # EXAMPLES OF PERMANOVA FROM VEGAN DOCUMENTATION
# 
# ### Example of use with strata, for nested (e.g., block) designs.
# dat <- expand.grid(rep=gl(2,1), NO3=factor(c(0,10)),field=gl(3,1) )
# dat
# Agropyron <- with(dat, as.numeric(field) + as.numeric(NO3)+2) +rnorm(12)/2
# Schizachyrium <- with(dat, as.numeric(field) - as.numeric(NO3)+2) +rnorm(12)/2
# total <- Agropyron + Schizachyrium
# dotplot(total ~ NO3, dat, jitter.x=TRUE, groups=field,
#         type=c('p','a'), xlab="NO3", auto.key=list(columns=3, lines=TRUE) )
# 
# Y <- data.frame(Agropyron, Schizachyrium)
# mod <- metaMDS(Y, trace = FALSE)
# plot(mod)
# ### Ellipsoid hulls show treatment
# with(dat, ordiellipse(mod, field, kind = "ehull", label = TRUE))
# ### Spider shows fields
# with(dat, ordispider(mod, field, lty=3, col="red"))
# 
# ### Incorrect (no strata)
# perm <- how(nperm = 199)
# adonis2 (Y ~ NO3, data = dat, permutations = perm)
# 
# ## Correct with strata
# setBlocks(perm) <- with(dat, field)
# adonis2(Y ~ NO3, data = dat, permutations = perm)
```
